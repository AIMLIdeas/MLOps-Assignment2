name: CD - CloudFormation Deployment Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'deployment/cloudformation/**'
      - '.github/workflows/cd-cloudformation.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'deployment/cloudformation/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        type: choice
        options:
          - deploy-eks
          - deploy-vpc
          - delete-stack
          - disable-protection
          - list-stacks
        default: 'deploy-eks'
      stack_name:
        description: 'Stack name (for delete action)'
        required: false
        type: string
      environment:
        description: 'Deployment environment'
        required: false
        type: choice
        options:
          - production
          - staging
          - development
        default: 'production'

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: mlops-mnist

jobs:
  validate-templates:
    name: Validate CloudFormation Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate VPC template
        run: |
          if [ -f deployment/cloudformation/vpc-stack.yaml ]; then
            echo "Validating VPC template..."
            aws cloudformation validate-template \
              --template-body file://deployment/cloudformation/vpc-stack.yaml \
              --region ${{ env.AWS_REGION }}
            echo "âœ“ VPC template is valid"
          fi

      - name: Validate EC2 template
        run: |
          if [ -f deployment/cloudformation/ec2-stack.yaml ]; then
            echo "Validating EC2 template..."
            aws cloudformation validate-template \
              --template-body file://deployment/cloudformation/ec2-stack.yaml \
              --region ${{ env.AWS_REGION }}
            echo "âœ“ EC2 template is valid"
          fi

      - name: Validate EKS template
        run: |
          if [ -f deployment/cloudformation/eks-stack.yaml ]; then
            echo "Validating EKS template..."
            aws cloudformation validate-template \
              --template-body file://deployment/cloudformation/eks-stack.yaml \
              --region ${{ env.AWS_REGION }}
            echo "âœ“ EKS template is valid"
          fi

      - name: Validation Summary
        run: |
          echo "## âœ“ All CloudFormation templates validated successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All templates passed AWS CloudFormation validation." >> $GITHUB_STEP_SUMMARY

  deploy-infrastructure:
    name: Deploy Infrastructure
    needs: validate-templates
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push'
    environment:
      name: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS credentials
        run: |
          echo "## AWS Credentials Verified âœ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          aws sts get-caller-identity
          
          echo "## Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ inputs.action || 'deploy-eks (default)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment || 'production (default)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Make deployment script executable
        run: chmod +x deployment/cloudformation/deploy-stacks.sh

      - name: Set environment variables
        run: |
          echo "ENVIRONMENT=${{ inputs.environment || 'production' }}" >> $GITHUB_ENV
          echo "ACTION=${{ inputs.action || 'deploy-eks' }}" >> $GITHUB_ENV
          echo "Deployment action: ${{ inputs.action || 'deploy-eks' }}" >> $GITHUB_STEP_SUMMARY

      - name: Deploy VPC Stack
        if: env.ACTION == 'deploy-vpc' || env.ACTION == 'deploy-eks'
        run: |
          echo "## Deploying VPC Stack" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STACK_NAME="${PROJECT_NAME}-vpc-${ENVIRONMENT}"
          
          aws cloudformation deploy \
            --template-file deployment/cloudformation/vpc-stack.yaml \
            --stack-name $STACK_NAME \
            --capabilities CAPABILITY_IAM \
            --no-disable-rollback \
            --region $AWS_REGION \
            --tags \
              Project=$PROJECT_NAME \
              Environment=$ENVIRONMENT \
              ManagedBy=CloudFormation \
              TerminationProtection=Disabled \
            --parameter-overrides \
              Environment=$ENVIRONMENT \
              Project=$PROJECT_NAME
          
          # Explicitly disable termination protection
          aws cloudformation update-termination-protection \
            --stack-name $STACK_NAME \
            --no-enable-termination-protection \
            --region $AWS_REGION
          
          echo "âœ“ VPC Stack deployed with termination protection DISABLED" >> $GITHUB_STEP_SUMMARY
          
          # Get outputs
          aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --query 'Stacks[0].Outputs' \
            --output table | tee -a $GITHUB_STEP_SUMMARY

      - name: Deploy EKS Stack
        if: env.ACTION == 'deploy-eks'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deploying EKS Stack (Primary Application Platform)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **Note:** EKS cluster creation takes 15-20 minutes" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Application deployment target:** EKS (not EC2)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STACK_NAME="${PROJECT_NAME}-eks-${ENVIRONMENT}"
          VPC_STACK="${PROJECT_NAME}-vpc-${ENVIRONMENT}"
          
          # Check if VPC stack exists
          if aws cloudformation describe-stacks --stack-name $VPC_STACK --region $AWS_REGION 2>/dev/null; then
            VPC_PARAM="VPCStackName=$VPC_STACK"
          else
            VPC_PARAM="VPCStackName="
          fi
          
          aws cloudformation deploy \
            --template-file deployment/cloudformation/eks-stack.yaml \
            --stack-name $STACK_NAME \
            --capabilities CAPABILITY_NAMED_IAM \
            --no-disable-rollback \
            --region $AWS_REGION \
            --tags \
              Project=$PROJECT_NAME \
              Environment=$ENVIRONMENT \
              ManagedBy=CloudFormation \
              TerminationProtection=Disabled \
            --parameter-overrides \
              Environment=$ENVIRONMENT \
              Project=$PROJECT_NAME \
              ClusterName=mlops-assignment2-cluster \
              $VPC_PARAM
          
          # Explicitly disable termination protection
          aws cloudformation update-termination-protection \
            --stack-name $STACK_NAME \
            --no-enable-termination-protection \
            --region $AWS_REGION
          
          echo "âœ“ EKS Stack deployed with termination protection DISABLED" >> $GITHUB_STEP_SUMMARY
          
          # Get outputs
          aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --region $AWS_REGION \
            --query 'Stacks[0].Outputs' \
            --output table | tee -a $GITHUB_STEP_SUMMARY

      - name: Install kubectl
        if: env.ACTION == 'deploy-eks'
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for EKS
        if: env.ACTION == 'deploy-eks'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuring kubectl for EKS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Update kubeconfig
          aws eks update-kubeconfig \
            --region $AWS_REGION \
            --name mlops-assignment2-cluster
          
          # Verify connection
          kubectl version --client
          kubectl cluster-info
          
          echo "âœ“ kubectl configured successfully" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Application to EKS
        if: env.ACTION == 'deploy-eks'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deploying Application to EKS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Apply Kubernetes manifests in order
          echo "Applying namespace..."
          kubectl apply -f deployment/kubernetes/namespace.yaml
          
          echo "Applying configmap..."
          kubectl apply -f deployment/kubernetes/configmap.yaml
          
          echo "Applying deployment..."
          kubectl apply -f deployment/kubernetes/deployment.yaml
          
          echo "Applying service..."
          kubectl apply -f deployment/kubernetes/service.yaml
          
          echo "Applying HPA..."
          kubectl apply -f deployment/kubernetes/hpa.yaml
          
          echo "âœ“ Application manifests deployed" >> $GITHUB_STEP_SUMMARY

      - name: Wait for Deployment
        if: env.ACTION == 'deploy-eks'
        run: |
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/cat-dogs-deployment -n mlops --timeout=5m
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n mlops -l app=cat-dogs-classifier -o wide >> $GITHUB_STEP_SUMMARY

      - name: Get Service URL
        if: env.ACTION == 'deploy-eks'
        id: get-service-url
        run: |
          echo "Waiting for LoadBalancer to be provisioned..."
          sleep 30
          
          SERVICE_URL=$(kubectl get svc cat-dogs-service -n mlops -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "pending")
          
          if [ "$SERVICE_URL" != "pending" ] && [ -n "$SERVICE_URL" ]; then
            echo "service_url=http://$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸŒ Application URL" >> $GITHUB_STEP_SUMMARY
            echo "**Service URL:** http://$SERVICE_URL" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "# Health check" >> $GITHUB_STEP_SUMMARY
            echo "curl http://$SERVICE_URL/health" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Test prediction" >> $GITHUB_STEP_SUMMARY
            echo "curl -X POST -F 'file=@image.jpg' http://$SERVICE_URL/predict" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "service_url=pending" >> $GITHUB_OUTPUT
            echo "âš ï¸ LoadBalancer URL not yet available. Check AWS Console." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Delete Stack
        if: env.ACTION == 'delete-stack' && inputs.stack_name != ''
        run: |
          echo "## Deleting Stack: ${{ inputs.stack_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Disable termination protection first
          aws cloudformation update-termination-protection \
            --stack-name ${{ inputs.stack_name }} \
            --no-enable-termination-protection \
            --region $AWS_REGION || true
          
          # Delete the stack
          aws cloudformation delete-stack \
            --stack-name ${{ inputs.stack_name }} \
            --region $AWS_REGION
          
          echo "Stack deletion initiated for: ${{ inputs.stack_name }}" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ This operation may take several minutes" >> $GITHUB_STEP_SUMMARY

      - name: Disable Termination Protection
        if: env.ACTION == 'disable-protection'
        run: |
          echo "## Disabling Termination Protection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Get all stacks with project tag
          STACKS=$(aws cloudformation describe-stacks \
            --region $AWS_REGION \
            --query "Stacks[?Tags[?Key=='Project' && Value=='${PROJECT_NAME}']].StackName" \
            --output text)
          
          for STACK in $STACKS; do
            echo "Disabling termination protection for: $STACK"
            aws cloudformation update-termination-protection \
              --stack-name $STACK \
              --no-enable-termination-protection \
              --region $AWS_REGION || true
            echo "âœ“ $STACK" >> $GITHUB_STEP_SUMMARY
          done

      - name: List Stacks
        if: env.ACTION == 'list-stacks' || env.ACTION == 'disable-protection'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## CloudFormation Stacks Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          aws cloudformation describe-stacks \
            --region $AWS_REGION \
            --query "Stacks[?Tags[?Key=='Project' && Value=='${PROJECT_NAME}']].[StackName,StackStatus,EnableTerminationProtection]" \
            --output table | tee -a $GITHUB_STEP_SUMMARY

      - name: Verify Termination Protection Disabled
        if: env.ACTION != 'delete-stack' && env.ACTION != 'list-stacks'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Termination Protection Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          STACKS=$(aws cloudformation describe-stacks \
            --region $AWS_REGION \
            --query "Stacks[?Tags[?Key=='Project' && Value=='${PROJECT_NAME}']].StackName" \
            --output text)
          
          ALL_DISABLED=true
          for STACK in $STACKS; do
            PROTECTION=$(aws cloudformation describe-stacks \
              --stack-name $STACK \
              --region $AWS_REGION \
              --query 'Stacks[0].EnableTerminationProtection' \
              --output text)
            
            if [ "$PROTECTION" == "False" ]; then
              echo "âœ“ $STACK: Termination protection DISABLED" >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ $STACK: Termination protection ENABLED" >> $GITHUB_STEP_SUMMARY
              ALL_DISABLED=false
            fi
          done
          
          if [ "$ALL_DISABLED" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **All stacks have termination protection DISABLED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Warning: Some stacks still have termination protection enabled**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ env.ACTION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Project:** ${{ env.PROJECT_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Termination Protection:** DISABLED for all stacks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Deployment Architecture" >> $GITHUB_STEP_SUMMARY
          echo "1. **Infrastructure Layer** (CloudFormation)" >> $GITHUB_STEP_SUMMARY
          echo "   - VPC with multi-AZ subnets" >> $GITHUB_STEP_SUMMARY
          echo "   - EKS Kubernetes cluster (v1.28)" >> $GITHUB_STEP_SUMMARY
          echo "   - Node group with auto-scaling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Application Layer** (Kubernetes)" >> $GITHUB_STEP_SUMMARY
          echo "   - Cat/Dogs classifier deployment" >> $GITHUB_STEP_SUMMARY
          echo "   - LoadBalancer service" >> $GITHUB_STEP_SUMMARY
          echo "   - Horizontal Pod Autoscaler" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— AWS Console Links" >> $GITHUB_STEP_SUMMARY
          echo "- [CloudFormation Stacks](https://console.aws.amazon.com/cloudformation/home?region=${{ env.AWS_REGION }})" >> $GITHUB_STEP_SUMMARY
          echo "- [EKS Clusters](https://console.aws.amazon.com/eks/home?region=${{ env.AWS_REGION }}#/clusters)" >> $GITHUB_STEP_SUMMARY
          echo "- [EC2 Load Balancers](https://console.aws.amazon.com/ec2/home?region=${{ env.AWS_REGION }}#LoadBalancers:)" >> $GITHUB_STEP_SUMMARY
          echo "- [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logs:)" >> $GITHUB_STEP_SUMMARY
