name: CD - Deploy to AWS

on:
  # Trigger on successful CI completion or manual dispatch
  workflow_run:
    workflows: ["CI - Test Docker Image"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (default: latest commit SHA)'
        required: false
        type: string
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy to AWS EKS
    # Only deploy if CI workflow succeeded (image was tested successfully)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: ${{ steps.get-url.outputs.service_url }}
    permissions:
      contents: read
      packages: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check AWS credentials
        id: check-creds
        run: |
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ] || [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "has_creds=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ AWS credentials not configured in GitHub Secrets" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable AWS deployment, add these secrets:" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to: https://github.com/AIMLIdeas/MLOps-Assignment2/settings/secrets/actions" >> $GITHUB_STEP_SUMMARY
            echo "2. Add secret: AWS_ACCESS_KEY_ID" >> $GITHUB_STEP_SUMMARY
            echo "3. Add secret: AWS_SECRET_ACCESS_KEY" >> $GITHUB_STEP_SUMMARY
            echo "4. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_creds=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify image availability
        run: |
          echo "## Deployment Starting ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deploying tested image that passed CI" >> $GITHUB_STEP_SUMMARY
          echo "- **Image tag:** \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY

      - name: Configure AWS credentials
        if: steps.check-creds.outputs.has_creds == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: image-tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            # Use latest tag for production deployments
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          TAG=$(grep tag $GITHUB_OUTPUT | cut -d= -f2)
          echo "Deploying image tag: ${TAG}"

      - name: Install kubectl
        if: steps.check-creds.outputs.has_creds == 'true'
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Update kubeconfig for EKS
        if: steps.check-creds.outputs.has_creds == 'true'
        run: |
          aws eks update-kubeconfig --region us-east-1 --name mnist-classifier-cluster
          kubectl version --client
          kubectl cluster-info

      - name: Deploy to EKS
        if: steps.check-creds.outputs.has_creds == 'true'
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "Deploying image: ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${IMAGE_TAG}"
          
          # Apply Kubernetes manifests in order
          echo "Applying namespace..."
          kubectl apply -f deployment/kubernetes/namespace.yaml
          
          echo "Applying configmap..."
          kubectl apply -f deployment/kubernetes/configmap.yaml
          
          echo "Applying GHCR secret..."
          kubectl apply -f deployment/kubernetes/secret-ghcr.yaml
          
          echo "Applying deployment..."
          kubectl apply -f deployment/kubernetes/deployment.yaml
          
          echo "Applying service..."
          kubectl apply -f deployment/kubernetes/service.yaml
          
          echo "Applying HPA..."
          kubectl apply -f deployment/kubernetes/hpa.yaml
          
          # Update deployment with specific tested image
          echo "Updating deployment with tested image: ${IMAGE_TAG}"
          kubectl set image deployment/cat-dogs-deployment \
            cat-dogs-classifier=ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${IMAGE_TAG} \
            -n mlops
          
          # Annotate deployment with build info
          kubectl annotate deployment/cat-dogs-deployment \
            kubernetes.io/change-cause="Deployed by GitHub Actions - SHA: ${IMAGE_TAG}" \
            -n mlops --overwrite

      - name: Verify deployment
        if: steps.check-creds.outputs.has_creds == 'true'
        run: |
          echo "Waiting for rollout to complete..."
          kubectl rollout status deployment/cat-dogs-deployment -n mlops --timeout=5m
          
          echo ""
          echo "Deployment successful! Checking pods..."
          kubectl get pods -n mlops -l app=cat-dogs-classifier
          
          echo ""
          echo "Service details:"
          kubectl get svc cat-dogs-service -n mlops
          
          echo ""
          echo "HPA status:"
          kubectl get hpa -n mlops

      - name: Run smoke tests
        if: steps.check-creds.outputs.has_creds == 'true'
        id: smoke-test
        run: |
          echo "Waiting for service to be ready..."
          sleep 30
          
          SERVICE_URL=$(kubectl get svc cat-dogs-service -n mlops -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          
          if [ -n "$SERVICE_URL" ]; then
            echo "Testing health endpoint at http://$SERVICE_URL:8000/health"
            
            # Retry health check up to 5 times
            for i in {1..5}; do
              if curl -f -s http://$SERVICE_URL:8000/health; then
                echo ""
                echo "âœ“ Health check passed!"
                echo "service_url=http://$SERVICE_URL:8000" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "Attempt $i failed, retrying..."
                sleep 10
              fi
            done
            
            echo "Health check failed after 5 attempts"
            exit 1
          else
            echo "Warning: LoadBalancer URL not yet available. Checking service status..."
            kubectl describe svc cat-dogs-service -n mlops
            exit 1
          fi
      
      - name: Get service URL
        if: steps.check-creds.outputs.has_creds == 'true'
        id: get-url
        run: |
          SERVICE_URL=$(kubectl get svc cat-dogs-service -n mlops -o jsonpath='{.status.loadBalancer.ingress[0].hostname}')
          if [ -n "$SERVICE_URL" ]; then
            echo "service_url=http://$SERVICE_URL:8000" >> $GITHUB_OUTPUT
          else
            echo "service_url=pending" >> $GITHUB_OUTPUT
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-creds.outputs.has_creds }}" == "true" ]; then
            echo "### Deployment Details" >> $GITHUB_STEP_SUMMARY
            echo "- **Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Region:** us-east-1" >> $GITHUB_STEP_SUMMARY
            echo "- **Cluster:** mnist-classifier-cluster" >> $GITHUB_STEP_SUMMARY
            echo "- **Namespace:** mlops" >> $GITHUB_STEP_SUMMARY
            echo "- **Image:** \`ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            SERVICE_URL="${{ steps.get-url.outputs.service_url }}"
            if [ "$SERVICE_URL" != "pending" ] && [ -n "$SERVICE_URL" ]; then
              echo "### Service URL" >> $GITHUB_STEP_SUMMARY
              echo "ðŸŒ **API Endpoint:** $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Test the API" >> $GITHUB_STEP_SUMMARY
              echo '```bash' >> $GITHUB_STEP_SUMMARY
              echo "# Health check" >> $GITHUB_STEP_SUMMARY
              echo "curl $SERVICE_URL/health" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "# Test prediction (upload an image)" >> $GITHUB_STEP_SUMMARY
              echo "curl -X POST -F 'file=@your-image.jpg' $SERVICE_URL/predict" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Service URL:** Pending (LoadBalancer provisioning)" >> $GITHUB_STEP_SUMMARY
            fi
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### AWS Console Links" >> $GITHUB_STEP_SUMMARY
            echo "- [EKS Cluster](https://console.aws.amazon.com/eks/home?region=us-east-1#/clusters/mnist-classifier-cluster)" >> $GITHUB_STEP_SUMMARY
            echo "- [CloudWatch Logs](https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#logs:)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ AWS Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "AWS credentials are not configured in GitHub Secrets." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**To enable AWS EKS deployment:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Go to [Repository Secrets](https://github.com/AIMLIdeas/MLOps-Assignment2/settings/secrets/actions)" >> $GITHUB_STEP_SUMMARY
            echo "2. Click **New repository secret**" >> $GITHUB_STEP_SUMMARY
            echo "3. Add **AWS_ACCESS_KEY_ID** with your AWS access key" >> $GITHUB_STEP_SUMMARY
            echo "4. Add **AWS_SECRET_ACCESS_KEY** with your AWS secret key" >> $GITHUB_STEP_SUMMARY
            echo "5. Re-run this workflow" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**â„¹ï¸ Note:** The Docker image was still built and tested successfully!" >> $GITHUB_STEP_SUMMARY
            echo "- Image: \`ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
