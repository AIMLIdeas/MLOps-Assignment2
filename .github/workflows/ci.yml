name: CI - Test Docker Image

on:
  # Run after build-docker workflow completes
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [ main ]
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to test (default: commit SHA)'
        required: false
        type: string

jobs:
  test:
    name: Test Docker Image
    runs-on: ubuntu-latest
    # Only run if build workflow succeeded or if manually triggered
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: read
      packages: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image tag
        id: image-tag
        run: |
          if [ -n "${{ inputs.image_tag }}" ]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            # Use latest tag from main branch builds
            echo "tag=latest" >> $GITHUB_OUTPUT
          else
            echo "tag=latest" >> $GITHUB_OUTPUT
          fi
          TAG=$(grep tag $GITHUB_OUTPUT | cut -d= -f2)
          echo "Testing image: ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${TAG}"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image from registry
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "Pulling pre-built image from registry..."
          docker pull ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${IMAGE_TAG}

      - name: Run tests inside Docker container
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "Running tests inside the Docker container..."
          docker run --rm \
            -v ${{ github.workspace }}/tests:/app/tests \
            -v ${{ github.workspace }}/pytest.ini:/app/pytest.ini \
            ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${IMAGE_TAG} \
            pytest tests/ --maxfail=1 --disable-warnings -v

      - name: Verify container health
        env:
          IMAGE_TAG: ${{ steps.image-tag.outputs.tag }}
        run: |
          echo "Starting container to verify health endpoint..."
          CONTAINER_ID=$(docker run -d -p 8000:8000 ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${IMAGE_TAG})
          sleep 10
          curl -f http://localhost:8000/health || exit 1
          docker stop $CONTAINER_ID
          echo "âœ“ Container health check passed"
      
      - name: Test Summary
        if: always()
        run: |
          echo "## CI Test Summary ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`ghcr.io/aimlideas/mlops-assignment2/cats-dogs-classifier:${{ steps.image-tag.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
